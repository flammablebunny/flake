{ ... }:

let
  vars = import ./variables.nix;
  kb = vars.keybinds;
  apps = vars.apps;
  volumeStep = vars.misc.volumeStep;

  wsaction = "$HOME/.config/hypr/scripts/wsaction.fish";
  toggleWs = "$HOME/.config/hypr/scripts/toggle-workspace.sh";
in
{
  wayland.windowManager.hyprland.settings = {
    exec = [ "hyprctl dispatch submap global" ];

    "$wsaction" = wsaction;
    "$toggleWs" = toggleWs;

    submap = "global";

    # Regular binds
    bind = [
      # Shell keybinds - Launcher (QuickShell)
      "Super, Space, exec, quickshell ipc call search toggle"

      # Misc shell
      "${kb.session}, exec, quickshell ipc call session toggle"
      "${kb.showPanels}, exec, quickshell ipc call sidebarRight toggle"
      "${kb.lock}, exec, quickshell ipc call lock activate"

      # Go to workspace
      "${kb.goToWs}, 1, exec, $wsaction workspace 1"
      "${kb.goToWs}, 2, exec, $wsaction workspace 2"
      "${kb.goToWs}, 3, exec, $wsaction workspace 3"
      "${kb.goToWs}, 4, exec, $wsaction workspace 4"
      "${kb.goToWs}, 5, exec, $wsaction workspace 5"
      "${kb.goToWs}, 6, exec, $wsaction workspace 6"
      "${kb.goToWs}, 7, exec, $wsaction workspace 7"
      "${kb.goToWs}, 8, exec, $wsaction workspace 8"
      "${kb.goToWs}, 9, exec, $wsaction workspace 9"
      "${kb.goToWs}, 0, exec, $wsaction workspace 10"

      # Go to workspace group
      "${kb.goToWsGroup}, 1, exec, $wsaction -g workspace 1"
      "${kb.goToWsGroup}, 2, exec, $wsaction -g workspace 2"
      "${kb.goToWsGroup}, 3, exec, $wsaction -g workspace 3"
      "${kb.goToWsGroup}, 4, exec, $wsaction -g workspace 4"
      "${kb.goToWsGroup}, 5, exec, $wsaction -g workspace 5"
      "${kb.goToWsGroup}, 6, exec, $wsaction -g workspace 6"
      "${kb.goToWsGroup}, 7, exec, $wsaction -g workspace 7"
      "${kb.goToWsGroup}, 8, exec, $wsaction -g workspace 8"
      "${kb.goToWsGroup}, 9, exec, $wsaction -g workspace 9"
      "${kb.goToWsGroup}, 0, exec, $wsaction -g workspace 10"

      # Toggle special workspace (generic)
      "${kb.toggleSpecialWs}, togglespecialworkspace, special"

      # Move window to workspace
      "${kb.moveWinToWs}, 1, exec, $wsaction movetoworkspace 1"
      "${kb.moveWinToWs}, 2, exec, $wsaction movetoworkspace 2"
      "${kb.moveWinToWs}, 3, exec, $wsaction movetoworkspace 3"
      "${kb.moveWinToWs}, 4, exec, $wsaction movetoworkspace 4"
      "${kb.moveWinToWs}, 5, exec, $wsaction movetoworkspace 5"
      "${kb.moveWinToWs}, 6, exec, $wsaction movetoworkspace 6"
      "${kb.moveWinToWs}, 7, exec, $wsaction movetoworkspace 7"
      "${kb.moveWinToWs}, 8, exec, $wsaction movetoworkspace 8"
      "${kb.moveWinToWs}, 9, exec, $wsaction movetoworkspace 9"
      "${kb.moveWinToWs}, 0, exec, $wsaction movetoworkspace 10"

      # Move window to workspace group
      "${kb.moveWinToWsGroup}, 1, exec, $wsaction -g movetoworkspace 1"
      "${kb.moveWinToWsGroup}, 2, exec, $wsaction -g movetoworkspace 2"
      "${kb.moveWinToWsGroup}, 3, exec, $wsaction -g movetoworkspace 3"
      "${kb.moveWinToWsGroup}, 4, exec, $wsaction -g movetoworkspace 4"
      "${kb.moveWinToWsGroup}, 5, exec, $wsaction -g movetoworkspace 5"
      "${kb.moveWinToWsGroup}, 6, exec, $wsaction -g movetoworkspace 6"
      "${kb.moveWinToWsGroup}, 7, exec, $wsaction -g movetoworkspace 7"
      "${kb.moveWinToWsGroup}, 8, exec, $wsaction -g movetoworkspace 8"
      "${kb.moveWinToWsGroup}, 9, exec, $wsaction -g movetoworkspace 9"
      "${kb.moveWinToWsGroup}, 0, exec, $wsaction -g movetoworkspace 10"

      # Mouse move window to workspace
      "Super+Alt, mouse_down, movetoworkspace, -1"
      "Super+Alt, mouse_up, movetoworkspace, +1"

      # Move window to/from special workspace
      "Ctrl+Super+Shift, up, movetoworkspace, special:special"
      "Ctrl+Super+Shift, down, movetoworkspace, e+0"
      "Super+Alt, S, movetoworkspace, special:special"

      # Window groups
      "${kb.toggleGroup}, togglegroup"
      "${kb.ungroup}, moveoutofgroup"
      "Super+Shift, Comma, lockactivegroup, toggle"

      # Window focus/movement
      "Super, left, movefocus, l"
      "Super, right, movefocus, r"
      "Super, up, movefocus, u"
      "Super, down, movefocus, d"
      "Super+Shift, left, movewindow, l"
      "Super+Shift, right, movewindow, r"
      "Super+Shift, up, movewindow, u"
      "Super+Shift, down, movewindow, d"

      # Window center and resize
      "Ctrl+Super, Backslash, centerwindow, 1"
      "Ctrl+Super+Alt, Backslash, resizeactive, exact 55% 70%"
      "Ctrl+Super+Alt, Backslash, centerwindow, 1"
      # PIP mode - resize to corner
      "${kb.windowPip}, resizeactive, exact 25% 25%"
      "${kb.windowPip}, moveactive, exact 73% 73%"
      "${kb.pinWindow}, pin"
      "${kb.windowFullscreen}, fullscreen, 0"
      "${kb.windowBorderedFullscreen}, fullscreen, 1"
      "${kb.toggleWindowFloating}, togglefloating,"
      "${kb.closeWindow}, killactive,"

      # Special workspace toggles (using toggle-workspace.sh)
      "${kb.systemMonitor}, exec, $toggleWs sysmon btop 'foot --app-id=btop btop'"
      "${kb.communication}, exec, $toggleWs communication discord discord"
      "${kb.slack}, exec, $toggleWs slack Slack slack"
      "${kb.recording}, exec, $toggleWs recording com.obsproject.Studio obs"
      "${kb.music}, exec, $toggleWs music Spotify spotify"

      # Apps
      "${kb.terminal}, exec, app2unit -- ${apps.terminal}"
      "${kb.browser}, exec, app2unit -- ${apps.browser}"
      "${kb.editor}, exec, app2unit -- ${apps.editor}"
      "${kb.fileExplorer}, exec, app2unit -- ${apps.fileExplorer}"
      "Ctrl+Alt, Escape, exec, app2unit -- qps"
      "Ctrl+Alt, V, exec, app2unit -- pavucontrol"

      # Utilities - Screenshots (QuickShell region selector)
      "Super+Shift, S, exec, quickshell ipc call region edit"
      "Super+Shift+Alt, S, exec, quickshell ipc call region screenshot"
      "Super+Shift, C, exec, hyprpicker -a"

      # Sleep
      "Super+Shift, L, exec, systemctl suspend-then-hibernate"

      # Clipboard and emoji picker (QuickShell)
      "Super, V, exec, quickshell ipc call search clipboardToggle"
      "Super+Alt, V, exec, cliphist list | fuzzel -d | cliphist delete"
      "Super, Period, exec, fuzzel-emoji"
    ];


      # Restore lock
      "${kb.restoreLock}, exec, quickshell ipc call lock focus"

      # Brightness (QuickShell)
      ", XF86MonBrightnessUp, exec, quickshell ipc call brightness increment"
      ", XF86MonBrightnessDown, exec, quickshell ipc call brightness decrement"

     
      # Media (QuickShell)
      "Ctrl+Super, Space, exec, quickshell ipc call mpris playPause"
      ", XF86AudioPlay, exec, quickshell ipc call mpris playPause"
      ", XF86AudioPause, exec, quickshell ipc call mpris playPause"
      "Ctrl+Super, Equal, exec, quickshell ipc call mpris next"
      ", XF86AudioNext, exec, quickshell ipc call mpris next"
      "Ctrl+Super, Minus, exec, quickshell ipc call mpris previous"
      ", XF86AudioPrev, exec, quickshell ipc call mpris previous"
      ", XF86AudioStop, exec, quickshell ipc call mpris pauseAll"

      # Volume
      ", XF86AudioMute, exec, wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle"
      "Super+Shift, M, exec, wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle"

      # Clipboard paste
      "Ctrl+Shift+Alt, V, exec, sleep 0.5s && ydotool type -d 1 \"$(cliphist list | head -1 | cliphist decode)\""

    ];

    # Repeat binds (binde)
    binde = [
      # Workspace navigation
      "${kb.prevWs}, workspace, -1"
      "${kb.nextWs}, workspace, +1"
      "Super, Page_Up, workspace, -1"
      "Super, Page_Down, workspace, +1"

      # Move window to workspace
      "Super+Alt, Page_Up, movetoworkspace, -1"
      "Super+Alt, Page_Down, movetoworkspace, +1"
      "Ctrl+Super+Shift, right, movetoworkspace, +1"
      "Ctrl+Super+Shift, left, movetoworkspace, -1"

      # Window groups
      "${kb.windowGroupCycleNext}, cyclenext, activewindow"
      "${kb.windowGroupCyclePrev}, cyclenext, prev, activewindow"
      "Ctrl+Alt, Tab, changegroupactive, f"
      "Ctrl+Shift+Alt, Tab, changegroupactive, b"

      # Split ratio
      "Super, Minus, splitratio, -0.1"
      "Super, Equal, splitratio, 0.1"
    ];

    # Lock-screen-safe repeat binds (bindle)
    bindle = [
      # Volume
      ", XF86AudioRaiseVolume, exec, wpctl set-mute @DEFAULT_AUDIO_SINK@ 0; wpctl set-volume -l 1 @DEFAULT_AUDIO_SINK@ ${toString volumeStep}%+"
      ", XF86AudioLowerVolume, exec, wpctl set-mute @DEFAULT_AUDIO_SINK@ 0; wpctl set-volume @DEFAULT_AUDIO_SINK@ ${toString volumeStep}%-"
    ];

    # Release binds (bindr)
    bindr = [
      # Kill/restart QuickShell
      "Ctrl+Super+Shift, R, exec, pkill quickshell"
      "Ctrl+Super+Alt, R, exec, pkill quickshell; sleep 0.5; env QSG_RHI_BACKEND=opengl QSG_RENDER_LOOP=basic quickshell -d"
    ];

    # Mouse binds for dragging windows
    bindm = [
      "Super, mouse:272, movewindow"
      "Super, mouse:273, resizewindow"
      "Super, X, movewindow"
      "Super, Z, resizewindow"
    ];
  };
}
